<html>
	<head>
		<script type="text/javascript" src="http://127.0.0.1:83/Application/www/sapp/src/asl.js"></script>
		<script>
			setInterval(function()
			{
				window.gc();
				if(typeof memory != 'undefined')memory.getMemoryStats();
			}, 5000);
		
			var id = 0;
			var inflight = 0;
			var url = "ajax.txt";
			var MAXIMUM_WAITING_TIME = 20 * 1000; //How long to wait for an AJAX to return before aborting it.
			var NUMBER_OF_SIMUL_XMLHTTP = 10; 
			var DELAY = 0.5 * 1000; //0.5second delay after the last AJAX test run returns before the next test run is fired.
			var numberSent = 0;
			var numberErrored = 0;
			var numberReceived = 0;
			var numberInflight;
			var isStop = true;
			
			function loadXMLDoc(number)
			{
				var xmlhttp = new XMLHttpRequest();

				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
					{
						clearTimeout(requestTimer);
						if(xmlhttp.status == 200)
						{
							//All okay
							ajaxFinished(number, true);
						}
						else
						{
							//Some transmission/server error
							if(typeof generic != 'undefined') generic.Log('AJAX failed #: ' + id + " Status: " + xmlhttp.status + " Total Errors: " + numberErrored, 1);
							ajaxFinished(number, false);
							xmlhttp.abort();
						}
					}
				}		
				
				var requestTimer = setTimeout(function()
				{
					xmlhttp.abort();
					//ajaxFinished(number, false); //This is the bug line, readyState 4 will be called after abort, if it hasnt been done before.
				}, MAXIMUM_WAITING_TIME);
				
				xmlhttp.open("GET", "./" + url + "?id=" + id++, true);
				xmlhttp.send();
			}
			
			function runTestRun(iterations)
			{
				numberInflight = iterations;
				var output = document.getElementById('output');
				output.innerHTML = ''; //Yeah, I know; it's lazy...
				
				var statusBar = document.createElement('div');
				statusBar.textContent = 'Status: [';
				output.appendChild(statusBar);
				
				var closeStatus = document.createTextNode(']');
				
				for(var i = 0; i < iterations; i++)
				{
					var beforeText = document.createTextNode(',');
					var span = document.createElement('span');
					span.id = 'progress' + i;
					span.textContent = '~';
					if(i != 0)
					{
						statusBar.appendChild(beforeText);
					}
					statusBar.appendChild(span);
				}
				statusBar.appendChild(closeStatus);
				output.appendChild(statusBar);

				for(var j = 0; j < iterations; j++)
				{
					try
					{
						loadXMLDoc(j);
					}
					catch(e)
					{
						console.log(e);
					}
				}
				
				numberSent += NUMBER_OF_SIMUL_XMLHTTP;
				document.getElementById('sent').textContent = numberSent;
			}
			
			function ajaxFinished(number, isSuccess)
			{
				if(isSuccess)
				{
					document.getElementById('progress' + number).textContent = 'Y';
					document.getElementById('received').textContent = ++numberReceived;
				}
				else
				{
					document.getElementById('progress' + number).textContent = 'N';
					document.getElementById('error').textContent = ++numberErrored;
				}
				
				numberInflight--;
				if(numberInflight < 1)
				{
					launchTestRun();
				}
			}

			function launchTestRun()
			{
				setTimeout(function()
				{
					if(!isStop) runTestRun(NUMBER_OF_SIMUL_XMLHTTP);
				}, DELAY);
			}
			
			function memoryEvent(jsonObj)
			{
				document.getElementById('mem').textContent = jsonObj.availMemory;
			}

			//window.addEventListener('load', launchTestRun);
			
			
			function toggle()
			{
				isStop = !isStop;
				if(!isStop)
				{
					launchTestRun();
				}
			}
			
			if(typeof memory != 'undefined') memory.memoryEvent = 'memoryEvent(%json)';
		</script>
	</head>
	<body>
		<h3 onclick="toggle()">Simultaneous AJAX - Click here to start</h3>
		<a href="index1f.html">Reload</a>
		<div id="output"></div>
		<div>Sent: <span id="sent"></span></div>
		<div>Received: <span id="received"></span></div>
		<div>Errors: <span id="error"></span></div>
		<div>Memory: <span id="mem"></span></div>
	</body>
</html>
