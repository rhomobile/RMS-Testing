<html>
<head><script type="text/javascript" src="http://192.168.6.18/NEON/src/elements.js"></script>
    <title>PB 3.0 CardReader Test</title>
<META HTTP-Equiv="TextSize" Content="Smallest">
<meta name="mobileoptimized" content="0" />
 
<script language=javascript type="text/javascript">
var Generic = new ActiveXObject("PocketBrowser.Generic");

var SelectedItem="";
var SelectedMSR="";

function attachRead()
{   
    SelectAppropriateMSR();
    SetAutoEnter();
    SetAutoTab();
    SetPinEntry();
    SetPinTimeout();

    SelectedItem=frmCardReader.mydropdown2.value;
    
    var temp;

    if (SelectedItem == "HTML") {
        temp = "readevent:url('http://192.168.6.18/pb3.x/NavigateTest.html')";

    }
    else if (SelectedItem == "JavaScript") {
        temp = "readevent:url('javascript:MyReadEvent('%s', '%s');')";
    }
    else if(SelectedItem == "EMPTY")
    {
        temp = "readevent:url('')";
    }
  
    alert(temp);
    Generic.InvokeMETAFunction("cardreader",temp);
 
 
}
function SetAcceleratekey()
{
Generic.InvokeMETAFunction("KeyCapture", "AccelerateKey:All");
alert("AccelerateKey:All");
}

function MyReadEvent(data,mode)
{	
alert(data+mode);
    switch(mode)
    {
	
	case 'CR':
	  //alert("card data:-"+data);
		frmCardReader.txtCardData.value =data;
		ProcessCardData(data);
		break;
	case 'ENCDATA':
		frmCardReader.txtCardData.value ="Encrypted data:- "+data;
		break;
	case 'MESSAGE':
		frmCardReader.txtCardData.value ="Error:- "+data;
		break;
	case 'PAN':
		frmCardReader.txtCardData.value ="PAN:- "+data;
		if(SelectedMSR == "DCR7000")
		{
			alert("Please turn the unit over and enter the PIN");
		}
		break;		
    }					
}


function ProcessCardData(data)
{
    var carddata=data;
    var Track1Data,Track2Data,Track3Data;
    Track1Data="NULL";
    Track2Data="NULL";
    Track3Data="NULL";
    
    var position1 = carddata.indexOf('%');
    var position2 = carddata.indexOf('?');
    var carddatalength = carddata.length;
    if((position1==-1)||(position2==-1))
    {
        Track1Data="NULL";
    }
    else
    {
        Track1Data = carddata.substring(position1,position2);
        carddata=carddata.substring(position2+1,carddatalength);
        carddatalength=carddata.length;
    }

    position1=carddata.indexOf(';');
    position2=carddata.indexOf('?');

    if((position1==-1)||(position2==-1))
    {
        Track2Data="NULL";
    }
    else
    {
        Track2Data = carddata.substring(position1,position2);
        carddata=carddata.substring(position2+1,carddatalength);
        carddatalength=carddata.length;
    }
    if(SelectedMSR=="DCR7000")
    {
        position1=carddata.indexOf('%');
    }
    else if(SelectedMSR=="MSR9001")
    {
        position1=carddata.indexOf('+');
    }
    else
    {
        position1=carddata.indexOf(';');
    }
    position2=carddata.indexOf('?');

    if((position1==-1)||(position2==-1))
    {
        Track3Data="NULL";
    }
    else
    {
        Track3Data = carddata.substring(position1,position2);
    }


    frmCardReader.txtTrack1Data.value=Track1Data;
    frmCardReader.txtTrack2Data.value=Track2Data;
    frmCardReader.txtTrack3Data.value=Track3Data;
}


function OpenMSRCE()
{
    SelectAppropriateMSR();
    SetAutoEnter();
    SetAutoTab();
    SetPinEntry();
    SetPinTimeout();
	SetAcceleratekey();

    var bRetVal = Generic.InvokeMETAFunction("cardreader","open");
    if(bRetVal==true)
    {
    alert("Open success");
    }
    else
    {
    alert("Open Failed");
    }
    //SetPANData();
}

function OpenMSRWM()
{
    SelectAppropriateMSR();
    SetAutoEnter();
    SetAutoTab();
    SetPinEntry();
    SetPinTimeout();


    var bRetVal = Generic.InvokeMETAFunction("cardreader","open");
    if(bRetVal==true)
    {
    alert("Open success");
    }
    else
    {
    alert("Open Failed");
    }
    //SetPANData();
}

function CloseMSR()
{
   var bRetVal = Generic.InvokeMETAFunction("cardreader","close");
    if(bRetVal==true)
    {
    alert("Close success");
    }
    else
    {
    alert("Close Failed");
    }
}

function ClearTextboxes()
{  
    frmCardReader.txtCardData.value  ="";
    frmCardReader.txtTrack1Data.value="";
    frmCardReader.txtTrack2Data.value="";
    frmCardReader.txtTrack3Data.value="";
}



function SelectAppropriateMSR()
{
    SelectedMSR = frmCardReader.mydropdown.value;
    ModuleNameCommand = "modulename:" + SelectedMSR;
    Generic.InvokeMETAFunction("cardreader",ModuleNameCommand);
    alert(ModuleNameCommand);
}

function SetAutoEnter()
{
    var AutoEnterValue=frmCardReader.mydropdown3.value;

    //Generic.InvokeMETAFunction("KeyCapture", "AccelerateKey:All");
    if(AutoEnterValue=="True")
    {       
        Generic.InvokeMETAFunction("cardreader","autoenter:enabled");
        alert("autoenter:enabled");
    }
    else if(AutoEnterValue=="False")
    {        
        Generic.InvokeMETAFunction("cardreader","autoenter:disabled");
        alert("autoenter:disabled");
    }
}


function SetAutoTab()
{
    var AutoTabValue=frmCardReader.mydropdown4.value;
   
    if(AutoTabValue=="True")
    {
        Generic.InvokeMETAFunction("cardreader","autotab:enabled");
        alert("autotab:enabled");
    }
    else if(AutoTabValue=="False")
    {
        Generic.InvokeMETAFunction("cardreader","autotab:disabled");
        alert("autotab:disabled");
    }
}

function SetPinEntry()
{

 var SelectedIndex=frmCardReader.mydropdown5.selectedIndex;
 var PinEntryValue=frmCardReader.mydropdown5.options[SelectedIndex].value;
    if(PinEntryValue=="On")
    {
        Generic.InvokeMETAFunction("cardreader","pinEntry:ON");
        alert("pinentry:on");
    }
    else if(PinEntryValue=="Off")
    {
        Generic.InvokeMETAFunction("cardreader","pinEntry:OFF");
        alert("pinentry:off");
    }
}




function SetPinTimeout()
{
    var PinTimeout="";
    var temp="";
    PinTimeout="30000";
    if(PinTimeout!="")
    {
    temp="pintimeout:"+PinTimeout;
    Generic.InvokeMETAFunction("cardreader",temp);
    }
}



function SetPANData()
{
    var PANData="";
    var temp="";
    PANData=frmCardReader.Textarea1.value;
    
    
    if(PANData!="")
    {
    temp="pandata:"+PANData;
    alert(temp);
    Generic.InvokeMETAFunction("cardreader",temp);
    }
}

</script>
</head>
<body>



<form id="frmCardReader" action="">
<hr>
<hd>
<select name="mydropdown" id="mydropdown">
<option value="MSR9001">MSR9001</option>
<option value="DCR7000">DCR7000</option>
<option value="">Empthy</option>
<option value="MSR7000">MSR7000</option>
<option value="MSR9500">MSR9500</option>
<option value="MSR9000">MSR9000</option>
<option value="MSR55">MSR55</option>
<option value="MSR3000">MSR3000</option>
<option value="MSR">MSR</option>


</select>
</hd>

<hd>

<select name="mydropdown2">
<option value="JavaScript">JavaScript</option>
<option value="HTML">HTML</option>
<option value="EMPTY">Empty</option>
</select>

<hd>
</hr>

<table border=1 width=100%>
    <tr>

        <td><a href="main"></a></td>
    </tr>
    <tr>
        <td>Card Data:</td><td><Textarea id="txtCardData" cols="100" rows="3"></Textarea></td>
    </tr>
    <tr>
        <td>Track1 Data:</td><td><Textarea id="txtTrack1Data" cols="20" rows="1"></Textarea></td>

    </tr>
    <tr>
        <td>Track2 Data:</td><td><Textarea id="txtTrack2Data" cols="20" rows="1"></Textarea></td>
    </tr>
    <tr>
        <td>Track3 Data:</td><td><Textarea id="txtTrack3Data" cols="20" rows="1"></Textarea></td>
    </tr>
</table>


<table>

    <tr>
        <td>PinTimeOut:</td>
        <td><textarea id="txt1" cols="10" rows="1"></textarea></td>
    </tr>
    <tr>
        <td>PAN:</td><td><textarea id="Textarea1" cols="20" rows="1"></textarea></td>
    </tr>

</table>


<table>

<tr>
<td><a name="settings"></a></td>
</tr>


<tr>
<td>AutoEnter
<select name="mydropdown3">
<option value="False">False</option>
<option value="True">True</option>
</select>
</td>

<td>AutoTab
<select name="mydropdown4">
<option value="False">False</option>
<option value="True">True</option>
</select>
</td>
</tr>
<tr>
<td>PinEnt
<select name="mydropdown5">
<option value="NULL">NULL</option>
<option value="Off">Off</option>
<option value="On">On</option>
</select>
</td>
       <td><input type="button" id="Button2" onclick="SetPANData();" value="SetPANData"/></td>
</tr>
<tr>

    <td><input type="button" id="cmdOpen" onclick="OpenMSRCE();" value="Open MSRCE"/></td>
	<td><input type="button" id="cmdOpen1" onclick="OpenMSRWM();" value="Open MSRWM"/></td>

</tr>
<tr>


   <td><input type="button" id="Button1" onclick="attachRead();" value="Attach ReadEvent"/></td>
<td><input type="button" id="Button2" ONCLICK="CloseMSR();" value="Close"/></td>

</tr>

</table>






</form>
</body>
</html>

